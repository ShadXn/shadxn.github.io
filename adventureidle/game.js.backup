class IdleGame {
    constructor() {
        this.gameState = {
            level: 1,
            xp: 0,
            xpNeeded: 100,
            gold: 0,
            gems: 0,
            maxActiveActions: 1,
            unlockedActions: ['foraging', 'clicking'],
            unlockedAchievements: [],
            actionStats: {
                clicking: { level: 1, xp: 0, xpNeeded: 30, timesCompleted: 0 },
                foraging: { level: 1, xp: 0, xpNeeded: 50, timesCompleted: 0 },
                hunting: { level: 1, xp: 0, xpNeeded: 75, timesCompleted: 0 },
                mining: { level: 1, xp: 0, xpNeeded: 100, timesCompleted: 0 },
                questing: { level: 1, xp: 0, xpNeeded: 150, timesCompleted: 0 },
                fishing: { level: 1, xp: 0, xpNeeded: 60, timesCompleted: 0 },
                crafting: { level: 1, xp: 0, xpNeeded: 80, timesCompleted: 0 },
                exploring: { level: 1, xp: 0, xpNeeded: 120, timesCompleted: 0 },
                trading: { level: 1, xp: 0, xpNeeded: 90, timesCompleted: 0 }
            },
            upgrades: {},
            totalGoldEarned: 0,
            totalActionsCompleted: 0,
            clickerProgress: 0
        };

        this.actions = {
            clicking: {
                id: 'clicking',
                name: 'Clicking',
                icon: 'üëÜ',
                description: 'Click to gain progress!',
                baseXP: 5,
                baseGold: 2,
                unlockLevel: 1,
                type: 'clicker',
                clicksNeeded: 10
            },
            foraging: {
                id: 'foraging',
                name: 'Foraging',
                icon: 'üåø',
                description: 'Gather herbs and berries',
                baseXP: 10,
                baseGold: 5,
                unlockLevel: 1,
                duration: 1000,
                type: 'idle'
            },
            fishing: {
                id: 'fishing',
                name: 'Fishing',
                icon: 'üé£',
                description: 'Catch fish from rivers',
                baseXP: 15,
                baseGold: 8,
                unlockLevel: 2,
                duration: 1500,
                type: 'idle'
            },
            hunting: {
                id: 'hunting',
                name: 'Hunting',
                icon: 'üèπ',
                description: 'Hunt wild animals',
                baseXP: 25,
                baseGold: 15,
                unlockLevel: 4,
                duration: 2000,
                type: 'idle'
            },
            crafting: {
                id: 'crafting',
                name: 'Crafting',
                icon: 'üî®',
                description: 'Craft valuable items',
                baseXP: 35,
                baseGold: 20,
                unlockLevel: 7,
                duration: 2500,
                type: 'idle'
            },
            mining: {
                id: 'mining',
                name: 'Mining',
                icon: '‚õèÔ∏è',
                description: 'Mine precious ores',
                baseXP: 50,
                baseGold: 30,
                unlockLevel: 10,
                duration: 3000,
                type: 'idle'
            },
            trading: {
                id: 'trading',
                name: 'Trading',
                icon: 'üíº',
                description: 'Trade goods for profit',
                baseXP: 70,
                baseGold: 45,
                unlockLevel: 14,
                duration: 3500,
                type: 'idle'
            },
            exploring: {
                id: 'exploring',
                name: 'Exploring',
                icon: 'üó∫Ô∏è',
                description: 'Explore dangerous dungeons',
                baseXP: 90,
                baseGold: 55,
                unlockLevel: 18,
                duration: 4000,
                type: 'idle'
            },
            questing: {
                id: 'questing',
                name: 'Questing',
                icon: '‚öîÔ∏è',
                description: 'Complete epic quests',
                baseXP: 120,
                baseGold: 70,
                unlockLevel: 22,
                duration: 4500,
                type: 'idle'
            }
        };

        this.upgradeDefinitions = {
            foragingPower: {
                id: 'foragingPower',
                name: 'Foraging Mastery',
                icon: 'üåø',
                description: 'Increase XP from foraging',
                action: 'foraging',
                type: 'xp',
                baseCost: 20,
                costMultiplier: 1.5,
                effect: 5
            },
            foragingGold: {
                id: 'foragingGold',
                name: 'Foraging Profits',
                icon: 'üí∞',
                description: 'Increase gold from foraging',
                action: 'foraging',
                type: 'gold',
                baseCost: 25,
                costMultiplier: 1.5,
                effect: 3
            },
            foragingSpeed: {
                id: 'foragingSpeed',
                name: 'Fast Foraging',
                icon: '‚ö°',
                description: 'Reduce foraging time',
                action: 'foraging',
                type: 'speed',
                baseCost: 30,
                costMultiplier: 1.6,
                effect: 50,
                unlockLevel: 3
            },
            fishingPower: {
                id: 'fishingPower',
                name: 'Fishing Mastery',
                icon: 'üé£',
                description: 'Increase XP from fishing',
                action: 'fishing',
                type: 'xp',
                baseCost: 30,
                costMultiplier: 1.5,
                effect: 6,
                unlockLevel: 2
            },
            fishingGold: {
                id: 'fishingGold',
                name: 'Fishing Profits',
                icon: 'üí∞',
                description: 'Increase gold from fishing',
                action: 'fishing',
                type: 'gold',
                baseCost: 35,
                costMultiplier: 1.5,
                effect: 4,
                unlockLevel: 2
            },
            fishingSpeed: {
                id: 'fishingSpeed',
                name: 'Fast Fishing',
                icon: '‚ö°',
                description: 'Reduce fishing time',
                action: 'fishing',
                type: 'speed',
                baseCost: 40,
                costMultiplier: 1.6,
                effect: 75,
                unlockLevel: 5
            },
            huntingPower: {
                id: 'huntingPower',
                name: 'Hunting Mastery',
                icon: 'üèπ',
                description: 'Increase XP from hunting',
                action: 'hunting',
                type: 'xp',
                baseCost: 50,
                costMultiplier: 1.6,
                effect: 10,
                unlockLevel: 4
            },
            huntingGold: {
                id: 'huntingGold',
                name: 'Hunting Profits',
                icon: 'üí∞',
                description: 'Increase gold from hunting',
                action: 'hunting',
                type: 'gold',
                baseCost: 60,
                costMultiplier: 1.6,
                effect: 8,
                unlockLevel: 4
            },
            huntingSpeed: {
                id: 'huntingSpeed',
                name: 'Fast Hunting',
                icon: '‚ö°',
                description: 'Reduce hunting time',
                action: 'hunting',
                type: 'speed',
                baseCost: 70,
                costMultiplier: 1.7,
                effect: 100,
                unlockLevel: 8
            },
            craftingPower: {
                id: 'craftingPower',
                name: 'Crafting Mastery',
                icon: 'üî®',
                description: 'Increase XP from crafting',
                action: 'crafting',
                type: 'xp',
                baseCost: 75,
                costMultiplier: 1.6,
                effect: 15,
                unlockLevel: 7
            },
            craftingGold: {
                id: 'craftingGold',
                name: 'Crafting Profits',
                icon: 'üí∞',
                description: 'Increase gold from crafting',
                action: 'crafting',
                type: 'gold',
                baseCost: 85,
                costMultiplier: 1.6,
                effect: 10,
                unlockLevel: 7
            },
            craftingSpeed: {
                id: 'craftingSpeed',
                name: 'Fast Crafting',
                icon: '‚ö°',
                description: 'Reduce crafting time',
                action: 'crafting',
                type: 'speed',
                baseCost: 95,
                costMultiplier: 1.7,
                effect: 125,
                unlockLevel: 11
            },
            miningPower: {
                id: 'miningPower',
                name: 'Mining Mastery',
                icon: '‚õèÔ∏è',
                description: 'Increase XP from mining',
                action: 'mining',
                type: 'xp',
                baseCost: 100,
                costMultiplier: 1.7,
                effect: 20,
                unlockLevel: 10
            },
            miningGold: {
                id: 'miningGold',
                name: 'Mining Profits',
                icon: 'üí∞',
                description: 'Increase gold from mining',
                action: 'mining',
                type: 'gold',
                baseCost: 120,
                costMultiplier: 1.7,
                effect: 15,
                unlockLevel: 10
            },
            miningSpeed: {
                id: 'miningSpeed',
                name: 'Fast Mining',
                icon: '‚ö°',
                description: 'Reduce mining time',
                action: 'mining',
                type: 'speed',
                baseCost: 140,
                costMultiplier: 1.8,
                effect: 150,
                unlockLevel: 15
            },
            tradingPower: {
                id: 'tradingPower',
                name: 'Trading Mastery',
                icon: 'üíº',
                description: 'Increase XP from trading',
                action: 'trading',
                type: 'xp',
                baseCost: 150,
                costMultiplier: 1.7,
                effect: 25,
                unlockLevel: 14
            },
            tradingGold: {
                id: 'tradingGold',
                name: 'Trading Profits',
                icon: 'üí∞',
                description: 'Increase gold from trading',
                action: 'trading',
                type: 'gold',
                baseCost: 175,
                costMultiplier: 1.7,
                effect: 20,
                unlockLevel: 14
            },
            tradingSpeed: {
                id: 'tradingSpeed',
                name: 'Fast Trading',
                icon: '‚ö°',
                description: 'Reduce trading time',
                action: 'trading',
                type: 'speed',
                baseCost: 200,
                costMultiplier: 1.8,
                effect: 175,
                unlockLevel: 19
            },
            exploringPower: {
                id: 'exploringPower',
                name: 'Exploring Mastery',
                icon: 'üó∫Ô∏è',
                description: 'Increase XP from exploring',
                action: 'exploring',
                type: 'xp',
                baseCost: 200,
                costMultiplier: 1.8,
                effect: 30,
                unlockLevel: 18
            },
            exploringGold: {
                id: 'exploringGold',
                name: 'Exploring Profits',
                icon: 'üí∞',
                description: 'Increase gold from exploring',
                action: 'exploring',
                type: 'gold',
                baseCost: 225,
                costMultiplier: 1.8,
                effect: 25,
                unlockLevel: 18
            },
            exploringSpeed: {
                id: 'exploringSpeed',
                name: 'Fast Exploring',
                icon: '‚ö°',
                description: 'Reduce exploring time',
                action: 'exploring',
                type: 'speed',
                baseCost: 250,
                costMultiplier: 1.9,
                effect: 200,
                unlockLevel: 23
            },
            questingPower: {
                id: 'questingPower',
                name: 'Questing Mastery',
                icon: '‚öîÔ∏è',
                description: 'Increase XP from questing',
                action: 'questing',
                type: 'xp',
                baseCost: 250,
                costMultiplier: 1.8,
                effect: 40,
                unlockLevel: 22
            },
            questingGold: {
                id: 'questingGold',
                name: 'Questing Profits',
                icon: 'üí∞',
                description: 'Increase gold from questing',
                action: 'questing',
                type: 'gold',
                baseCost: 300,
                costMultiplier: 1.8,
                effect: 30,
                unlockLevel: 22
            },
            questingSpeed: {
                id: 'questingSpeed',
                name: 'Fast Questing',
                icon: '‚ö°',
                description: 'Reduce questing time',
                action: 'questing',
                type: 'speed',
                baseCost: 350,
                costMultiplier: 1.9,
                effect: 225,
                unlockLevel: 27
            }
        };

        this.achievements = {
            firstStep: {
                id: 'firstStep',
                name: 'First Steps',
                icon: 'üë£',
                description: 'Complete your first action',
                requirement: () => this.gameState.totalActionsCompleted >= 1,
                reward: { type: 'gold', amount: 50 }
            },
            level5: {
                id: 'level5',
                name: 'Getting Started',
                icon: 'üéØ',
                description: 'Reach level 5',
                requirement: () => this.gameState.level >= 5,
                reward: { type: 'gold', amount: 100 }
            },
            level10: {
                id: 'level10',
                name: 'Rising Star',
                icon: '‚≠ê',
                description: 'Reach level 10',
                requirement: () => this.gameState.level >= 10,
                reward: { type: 'gems', amount: 1 }
            },
            level20: {
                id: 'level20',
                name: 'Champion',
                icon: 'üèÜ',
                description: 'Reach level 20',
                requirement: () => this.gameState.level >= 20,
                reward: { type: 'gems', amount: 3 }
            },
            level30: {
                id: 'level30',
                name: 'Legend',
                icon: 'üëë',
                description: 'Reach level 30',
                requirement: () => this.gameState.level >= 30,
                reward: { type: 'gems', amount: 5 }
            },
            goldCollector: {
                id: 'goldCollector',
                name: 'Gold Collector',
                icon: 'üí∞',
                description: 'Earn 1,000 total gold',
                requirement: () => this.gameState.totalGoldEarned >= 1000,
                reward: { type: 'gold', amount: 200 }
            },
            goldMaster: {
                id: 'goldMaster',
                name: 'Gold Master',
                icon: 'üíé',
                description: 'Earn 10,000 total gold',
                requirement: () => this.gameState.totalGoldEarned >= 10000,
                reward: { type: 'gems', amount: 5 }
            },
            actionAddict: {
                id: 'actionAddict',
                name: 'Action Addict',
                icon: 'üî•',
                description: 'Complete 100 actions',
                requirement: () => this.gameState.totalActionsCompleted >= 100,
                reward: { type: 'gold', amount: 300 }
            },
            actionMaster: {
                id: 'actionMaster',
                name: 'Action Master',
                icon: 'üí™',
                description: 'Complete 500 actions',
                requirement: () => this.gameState.totalActionsCompleted >= 500,
                reward: { type: 'gems', amount: 3 }
            },
            foragingNovice: {
                id: 'foragingNovice',
                name: 'Foraging Novice',
                icon: 'üåø',
                description: 'Reach foraging level 5',
                requirement: () => this.gameState.actionStats.foraging.level >= 5,
                reward: { type: 'gold', amount: 75 }
            },
            foragingMaster: {
                id: 'foragingMaster',
                name: 'Foraging Master',
                icon: 'üå≥',
                description: 'Reach foraging level 10',
                requirement: () => this.gameState.actionStats.foraging.level >= 10,
                reward: { type: 'gems', amount: 2 }
            },
            huntingNovice: {
                id: 'huntingNovice',
                name: 'Hunting Novice',
                icon: 'üèπ',
                description: 'Reach hunting level 5',
                requirement: () => this.gameState.actionStats.hunting.level >= 5,
                reward: { type: 'gold', amount: 100 }
            },
            huntingMaster: {
                id: 'huntingMaster',
                name: 'Hunting Master',
                icon: 'üéØ',
                description: 'Reach hunting level 10',
                requirement: () => this.gameState.actionStats.hunting.level >= 10,
                reward: { type: 'gems', amount: 2 }
            },
            miningNovice: {
                id: 'miningNovice',
                name: 'Mining Novice',
                icon: '‚õèÔ∏è',
                description: 'Reach mining level 5',
                requirement: () => this.gameState.actionStats.mining.level >= 5,
                reward: { type: 'gold', amount: 150 }
            },
            miningMaster: {
                id: 'miningMaster',
                name: 'Mining Master',
                icon: 'üíé',
                description: 'Reach mining level 10',
                requirement: () => this.gameState.actionStats.mining.level >= 10,
                reward: { type: 'gems', amount: 3 }
            },
            questingNovice: {
                id: 'questingNovice',
                name: 'Questing Novice',
                icon: '‚öîÔ∏è',
                description: 'Reach questing level 5',
                requirement: () => this.gameState.actionStats.questing.level >= 5,
                reward: { type: 'gold', amount: 200 }
            },
            questingMaster: {
                id: 'questingMaster',
                name: 'Questing Master',
                icon: 'üõ°Ô∏è',
                description: 'Reach questing level 10',
                requirement: () => this.gameState.actionStats.questing.level >= 10,
                reward: { type: 'gems', amount: 3 }
            },
            allRounder: {
                id: 'allRounder',
                name: 'All-Rounder',
                icon: 'üåü',
                description: 'Unlock all actions',
                requirement: () => this.gameState.unlockedActions.length === Object.keys(this.actions).length,
                reward: { type: 'gems', amount: 5 }
            }
        };

        this.activeActions = {};
        this.init();
    }

    init() {
        this.loadGame();
        this.renderActions();
        this.renderUpgrades();
        this.renderAchievements();
        this.updateUI();
        this.setupEventListeners();
        this.startAutoSave();
        this.checkLevelUnlocks();
        this.checkAchievements();
    }

    setupEventListeners() {
        document.getElementById('saveBtn').addEventListener('click', () => {
            this.saveGame();
            this.showNotification('Game saved!');
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to reset your game? This cannot be undone!')) {
                localStorage.removeItem('idleGameSave');
                location.reload();
            }
        });

        document.getElementById('achievementsTab').addEventListener('click', () => {
            this.showTab('achievements');
        });

        document.getElementById('actionsTab').addEventListener('click', () => {
            this.showTab('actions');
        });

        document.getElementById('upgradesTab').addEventListener('click', () => {
            this.showTab('upgrades');
        });
    }

    showTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

        document.getElementById(`${tab}Tab`).classList.add('active');
        document.getElementById(`${tab}-section`).classList.add('active');
    }

    renderActions() {
        const actionsContainer = document.getElementById('actions');
        actionsContainer.innerHTML = '';

        Object.values(this.actions).forEach(action => {
            const isUnlocked = this.gameState.unlockedActions.includes(action.id);
            const canUnlock = this.gameState.level >= action.unlockLevel;
            const actionStats = this.gameState.actionStats[action.id];

            const card = document.createElement('div');
            card.className = `action-card ${!isUnlocked && !canUnlock ? 'locked' : ''}`;

            const xpReward = this.calculateReward(action, 'xp');
            const goldReward = this.calculateReward(action, 'gold');
            const actionXpReward = Math.floor(xpReward * 0.5);

            card.innerHTML = `
                <div class="card-header">
                    <div class="card-icon">${action.icon}</div>
                    <div>
                        <div class="card-title">${action.name}</div>
                        ${isUnlocked ? `<div class="skill-level">Skill Lv.${actionStats.level}</div>` : ''}
                    </div>
                    ${!isUnlocked && canUnlock ? '<span class="unlock-badge">NEW!</span>' : ''}
                </div>
                <div class="card-description">${action.description}</div>
                ${isUnlocked ? `
                    <div class="skill-progress">
                        <div class="skill-progress-bar">
                            <div class="skill-progress-fill" style="width: ${(actionStats.xp / actionStats.xpNeeded) * 100}%"></div>
                        </div>
                        <div class="skill-progress-text">${actionStats.xp}/${actionStats.xpNeeded} XP</div>
                    </div>
                ` : ''}
                <div class="card-rewards">
                    <span class="reward xp">+${xpReward} XP</span>
                    <span class="reward gold">+${goldReward} Gold</span>
                    ${isUnlocked ? `<span class="reward skill">+${actionXpReward} ${action.name} XP</span>` : ''}
                </div>
                ${!isUnlocked ? `<div style="color: #ef4444; font-size: 0.85rem;">Unlocks at level ${action.unlockLevel}</div>` : ''}
                <button class="action-btn" id="action-${action.id}" ${!isUnlocked ? 'disabled' : ''}>
                    ${!isUnlocked ? 'üîí Locked' : 'Start'}
                </button>
                <div class="progress-bar" id="progress-${action.id}" style="display: none;">
                    <div class="progress-fill" id="progress-fill-${action.id}"></div>
                </div>
            `;

            actionsContainer.appendChild(card);

            if (isUnlocked) {
                document.getElementById(`action-${action.id}`).addEventListener('click', () => {
                    this.startAction(action);
                });
            }
        });
    }

    renderUpgrades() {
        const upgradesContainer = document.getElementById('upgrades');
        upgradesContainer.innerHTML = '';

        Object.values(this.upgradeDefinitions).forEach(upgrade => {
            const currentLevel = this.gameState.upgrades[upgrade.id] || 0;
            const cost = this.calculateUpgradeCost(upgrade, currentLevel);
            const canAfford = this.gameState.gold >= cost;
            const isUnlocked = !upgrade.unlockLevel || this.gameState.level >= upgrade.unlockLevel;
            const maxLevel = 30;
            const isMaxed = currentLevel >= maxLevel;

            const card = document.createElement('div');
            card.className = `upgrade-card ${!isUnlocked ? 'locked' : ''}`;

            let effectText = '';
            if (upgrade.type === 'speed') {
                effectText = `-${upgrade.effect * (currentLevel + 1)}ms duration`;
            } else {
                effectText = `+${upgrade.effect * (currentLevel + 1)} ${upgrade.type}`;
            }

            card.innerHTML = `
                <div class="card-header">
                    <div class="card-icon">${upgrade.icon}</div>
                    <div class="card-title">${upgrade.name}</div>
                </div>
                <div class="card-description">${upgrade.description}</div>
                <div class="upgrade-level">Level: ${currentLevel}/${maxLevel}</div>
                <div style="margin-top: 5px; color: #10b981; font-weight: bold;">${effectText}</div>
                ${!isUnlocked ? `<div style="color: #ef4444; font-size: 0.85rem; margin-top: 5px;">Unlocks at level ${upgrade.unlockLevel}</div>` : ''}
                <button class="upgrade-btn" id="upgrade-${upgrade.id}" ${!canAfford || !isUnlocked || isMaxed ? 'disabled' : ''}>
                    ${isMaxed ? 'MAX' : `Upgrade (${cost} gold)`}
                </button>
            `;

            upgradesContainer.appendChild(card);

            if (isUnlocked && !isMaxed) {
                document.getElementById(`upgrade-${upgrade.id}`).addEventListener('click', () => {
                    this.purchaseUpgrade(upgrade);
                });
            }
        });
    }

    renderAchievements() {
        const achievementsContainer = document.getElementById('achievements');
        achievementsContainer.innerHTML = '';

        Object.values(this.achievements).forEach(achievement => {
            const isUnlocked = this.gameState.unlockedAchievements.includes(achievement.id);
            const canUnlock = achievement.requirement();

            const card = document.createElement('div');
            card.className = `achievement-card ${isUnlocked ? 'unlocked' : canUnlock ? 'ready' : 'locked'}`;

            const rewardText = achievement.reward.type === 'gold'
                ? `${achievement.reward.amount} Gold`
                : `${achievement.reward.amount} Gems`;

            card.innerHTML = `
                <div class="achievement-icon">${achievement.icon}</div>
                <div class="achievement-content">
                    <div class="achievement-title">${achievement.name}</div>
                    <div class="achievement-description">${achievement.description}</div>
                    <div class="achievement-reward">
                        ${isUnlocked ? '‚úÖ Unlocked!' : `üéÅ Reward: ${rewardText}`}
                    </div>
                </div>
            `;

            achievementsContainer.appendChild(card);
        });
    }

    calculateReward(action, type) {
        const base = type === 'xp' ? action.baseXP : action.baseGold;
        const upgradeKey = `${action.id}${type === 'xp' ? 'Power' : 'Gold'}`;
        const upgradeLevel = this.gameState.upgrades[upgradeKey] || 0;
        const upgrade = this.upgradeDefinitions[upgradeKey];

        if (!upgrade) return base;

        const upgradeBonus = upgrade.effect * upgradeLevel;
        const skillLevel = this.gameState.actionStats[action.id]?.level || 1;
        const skillBonus = Math.floor(base * (skillLevel - 1) * 0.1);

        return base + upgradeBonus + skillBonus;
    }

    calculateDuration(action) {
        const speedUpgradeKey = `${action.id}Speed`;
        const upgradeLevel = this.gameState.upgrades[speedUpgradeKey] || 0;
        const upgrade = this.upgradeDefinitions[speedUpgradeKey];

        if (!upgrade) return action.duration;

        const reduction = upgrade.effect * upgradeLevel;
        return Math.max(action.duration - reduction, 500);
    }

    calculateUpgradeCost(upgrade, currentLevel) {
        return Math.floor(upgrade.baseCost * Math.pow(upgrade.costMultiplier, currentLevel));
    }

    startAction(action) {
        if (this.activeActions[action.id]) return;

        const button = document.getElementById(`action-${action.id}`);
        const progressBar = document.getElementById(`progress-${action.id}`);
        const progressFill = document.getElementById(`progress-fill-${action.id}`);

        button.disabled = true;
        progressBar.style.display = 'block';

        const startTime = Date.now();
        const duration = this.calculateDuration(action);

        this.activeActions[action.id] = setInterval(() => {
            const elapsed = Date.now() - startTime;
            const progress = Math.min((elapsed / duration) * 100, 100);
            progressFill.style.width = `${progress}%`;

            if (progress >= 100) {
                this.completeAction(action);
            }
        }, 50);
    }

    completeAction(action) {
        clearInterval(this.activeActions[action.id]);
        delete this.activeActions[action.id];

        const xpGained = this.calculateReward(action, 'xp');
        const goldGained = this.calculateReward(action, 'gold');
        const actionXpGained = Math.floor(xpGained * 0.5);

        this.gameState.xp += xpGained;
        this.gameState.gold += goldGained;
        this.gameState.totalGoldEarned += goldGained;
        this.gameState.totalActionsCompleted += 1;

        const actionStats = this.gameState.actionStats[action.id];
        actionStats.timesCompleted += 1;
        actionStats.xp += actionXpGained;

        while (actionStats.xp >= actionStats.xpNeeded) {
            actionStats.xp -= actionStats.xpNeeded;
            actionStats.level += 1;
            actionStats.xpNeeded = Math.floor(actionStats.xpNeeded * 1.3);
            this.showNotification(`${action.icon} ${action.name} leveled up to ${actionStats.level}!`, true);
        }

        this.checkLevelUp();
        this.checkAchievements();
        this.updateUI();

        const activeActionsCopy = { ...this.activeActions };

        this.renderActions();
        this.renderUpgrades();

        this.restoreActiveActions(activeActionsCopy);
    }

    checkLevelUp() {
        while (this.gameState.xp >= this.gameState.xpNeeded) {
            this.gameState.xp -= this.gameState.xpNeeded;
            this.gameState.level++;
            this.gameState.xpNeeded = Math.floor(this.gameState.xpNeeded * 1.4);

            this.showNotification(`üéâ Level Up! You are now level ${this.gameState.level}!`, true);
            this.checkLevelUnlocks();
        }
    }

    checkLevelUnlocks() {
        let unlocked = false;

        Object.values(this.actions).forEach(action => {
            if (this.gameState.level >= action.unlockLevel &&
                !this.gameState.unlockedActions.includes(action.id)) {
                this.gameState.unlockedActions.push(action.id);
                this.showNotification(`üéä New action unlocked: ${action.name}!`);
                unlocked = true;
            }
        });

        if (unlocked) {
            const activeActionsCopy = { ...this.activeActions };
            this.renderActions();
            this.renderUpgrades();
            this.restoreActiveActions(activeActionsCopy);
        }
    }

    checkAchievements() {
        Object.values(this.achievements).forEach(achievement => {
            if (!this.gameState.unlockedAchievements.includes(achievement.id) &&
                achievement.requirement()) {
                this.gameState.unlockedAchievements.push(achievement.id);

                if (achievement.reward.type === 'gold') {
                    this.gameState.gold += achievement.reward.amount;
                } else if (achievement.reward.type === 'gems') {
                    this.gameState.gems += achievement.reward.amount;
                }

                const rewardText = achievement.reward.type === 'gold'
                    ? `${achievement.reward.amount} Gold`
                    : `${achievement.reward.amount} Gems`;

                this.showNotification(`üèÜ Achievement Unlocked: ${achievement.name}! (+${rewardText})`, true);
                this.renderAchievements();
                this.updateUI();
            }
        });
    }

    restoreActiveActions(activeActionsCopy) {
        Object.keys(activeActionsCopy).forEach(actionId => {
            const button = document.getElementById(`action-${actionId}`);
            const progressBar = document.getElementById(`progress-${actionId}`);

            if (button && progressBar) {
                button.disabled = true;
                progressBar.style.display = 'block';
            }
        });
    }

    purchaseUpgrade(upgrade) {
        const currentLevel = this.gameState.upgrades[upgrade.id] || 0;
        const cost = this.calculateUpgradeCost(upgrade, currentLevel);

        if (this.gameState.gold >= cost) {
            this.gameState.gold -= cost;
            this.gameState.upgrades[upgrade.id] = currentLevel + 1;
            this.updateUI();

            const activeActionsCopy = { ...this.activeActions };
            this.renderActions();
            this.renderUpgrades();
            this.restoreActiveActions(activeActionsCopy);

            this.showNotification(`‚¨ÜÔ∏è Upgraded ${upgrade.name}!`);
        }
    }

    updateUI() {
        document.getElementById('level').textContent = this.gameState.level;
        document.getElementById('xp').textContent = Math.floor(this.gameState.xp);
        document.getElementById('xpNeeded').textContent = this.gameState.xpNeeded;
        document.getElementById('gold').textContent = Math.floor(this.gameState.gold);
        document.getElementById('gems').textContent = this.gameState.gems;

        const achievementCount = this.gameState.unlockedAchievements.length;
        const totalAchievements = Object.keys(this.achievements).length;
        document.getElementById('achievementCount').textContent = `${achievementCount}/${totalAchievements}`;

        if (this.gameState.level >= 30) {
            this.showNotification('üèÜ Congratulations! You\'ve mastered the game! Keep playing to max out all skills and achievements!', true);
        }
    }

    showNotification(message, isLevelUp = false) {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${isLevelUp ? 'level-up' : ''}`;
        notification.classList.add('show');

        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    saveGame() {
        localStorage.setItem('idleGameSave', JSON.stringify(this.gameState));
    }

    loadGame() {
        const saved = localStorage.getItem('idleGameSave');
        if (saved) {
            const loadedState = JSON.parse(saved);
            this.gameState = { ...this.gameState, ...loadedState };

            Object.keys(this.actions).forEach(actionId => {
                if (!this.gameState.actionStats[actionId]) {
                    this.gameState.actionStats[actionId] = {
                        level: 1,
                        xp: 0,
                        xpNeeded: 50,
                        timesCompleted: 0
                    };
                }
            });
        }
    }

    startAutoSave() {
        setInterval(() => {
            this.saveGame();
        }, 10000);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new IdleGame();
});
